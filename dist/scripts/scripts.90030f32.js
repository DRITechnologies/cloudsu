function config($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/index/stacks"),$stateProvider.state("login",{url:"/login",templateUrl:"views/login.html",controller:"loginController"}).state("index",{"abstract":!0,url:"/index",templateUrl:"views/common/content.html"}).state("index.detail",{url:"/stacks/:stack_name",templateUrl:"views/stack.html",controller:"stackController"}).state("index.stacks",{url:"/stacks",templateUrl:"views/stacks.html",controller:"stacksController"}).state("index.users",{url:"/users",templateUrl:"views/users.html",controller:"usersController"}).state("index.system",{url:"/system",templateUrl:"views/system.html",controller:"system"})}function pageTitle($rootScope,$timeout){return{link:function(scope,element){var listener=function(event,toState,toParams,fromState,fromParams){var title="su";$timeout(function(){element.text(title)})};$rootScope.$on("$stateChangeStart",listener)}}}function sideNavigation($timeout){return{restrict:"A",link:function(scope,element){$timeout(function(){element.metisMenu()})}}}function iboxTools($timeout){return{restrict:"A",scope:!0,templateUrl:"views/common/ibox_tools.html",controller:function($scope,$element){$scope.showhide=function(){var ibox=$element.closest("div.ibox"),icon=$element.find("i:first"),content=ibox.find("div.ibox-content");content.slideToggle(200),icon.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down"),ibox.toggleClass("").toggleClass("border-bottom"),$timeout(function(){ibox.resize(),ibox.find("[id^=map-]").resize()},50)},$scope.closebox=function(){var ibox=$element.closest("div.ibox");ibox.remove()}}}}function minimalizaSidebar($timeout){return{restrict:"A",template:'<a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="" ng-click="minimalize()"><i class="fa fa-bars"></i></a>',controller:function($scope,$element){$scope.minimalize=function(){$("body").toggleClass("mini-navbar"),!$("body").hasClass("mini-navbar")||$("body").hasClass("body-small")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},200)):$("body").hasClass("fixed-sidebar")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},100)):$("#side-menu").removeAttr("style")}}}}function iboxToolsFullScreen($timeout){return{restrict:"A",scope:!0,templateUrl:"views/common/ibox_tools_full_screen.html",controller:function($scope,$element){$scope.showhide=function(){var ibox=$element.closest("div.ibox"),icon=$element.find("i:first"),content=ibox.find("div.ibox-content");content.slideToggle(200),icon.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down"),ibox.toggleClass("").toggleClass("border-bottom"),$timeout(function(){ibox.resize(),ibox.find("[id^=map-]").resize()},50)},$scope.closebox=function(){var ibox=$element.closest("div.ibox");ibox.remove()},$scope.fullscreen=function(){var ibox=$element.closest("div.ibox"),button=$element.find("i.fa-expand");$("body").toggleClass("fullscreen-ibox-mode"),button.toggleClass("fa-expand").toggleClass("fa-compress"),ibox.toggleClass("fullscreen"),setTimeout(function(){$(window).trigger("resize")},100)}}}}function alerts(){return{restrict:"E",templateUrl:"views/extras/alerts.html"}}function spinner(){return{restrict:"E",templateUrl:"views/extras/spinner.html"}}$(document).ready(function(){function fix_height(){var heightWithoutNavbar=$("body > #wrapper").height()-61;$(".sidebard-panel").css("min-height",heightWithoutNavbar+"px");var navbarHeigh=$("nav.navbar-default").height(),wrapperHeigh=$("#page-wrapper").height();navbarHeigh>wrapperHeigh&&$("#page-wrapper").css("min-height",navbarHeigh+"px"),wrapperHeigh>navbarHeigh&&$("#page-wrapper").css("min-height",$(window).height()+"px"),$("body").hasClass("fixed-nav")&&(navbarHeigh>wrapperHeigh?$("#page-wrapper").css("min-height",navbarHeigh-60+"px"):$("#page-wrapper").css("min-height",$(window).height()-60+"px"))}$(window).bind("load resize scroll",function(){$("body").hasClass("body-small")||fix_height()}),$(window).scroll(function(){$(window).scrollTop()>0&&!$("body").hasClass("fixed-nav")?$("#right-sidebar").addClass("sidebar-top"):$("#right-sidebar").removeClass("sidebar-top")}),setTimeout(function(){fix_height()})}),$(function(){$(window).bind("load resize",function(){$(document).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small")})}),function(){angular.module("stacks",["ui.router","ui.bootstrap","ngStorage","angularMoment","underscore","oitozero.ngSweetAlert","ace","toastr","ngAnimate","angular-ladda","ngPrettyJson"])}(),angular.module("stacks").config(config).run(function($rootScope,$state){$rootScope.$state=$state}),angular.module("stacks").directive("pageTitle",pageTitle).directive("sideNavigation",sideNavigation).directive("iboxTools",iboxTools).directive("minimalizaSidebar",minimalizaSidebar).directive("iboxToolsFullScreen",iboxToolsFullScreen).directive("spinner",spinner).directive("alerts",alerts),angular.module("stacks").controller("MainCtrl",function($scope,$http,$state,$uibModal,dataStore,SweetAlert){function childRefresh(){$scope.$broadcast("refresh")}function refresh(){$http.get("/api/v1/regions").success(function(regions){$scope.aws_regions=regions}),$http.get("/api/v1/services/list").success(function(accounts){$scope.aws_accounts=accounts})}$scope.userName=dataStore.getActiveUser(),$scope.activeAws=dataStore.getActiveAWS(),$scope.activeRegion=dataStore.getActiveRegion(),$scope.isLogin=dataStore.getIsLogin(),$scope.logout=function(){dataStore.clearAll(),$state.go("login")},$scope.getToken=function(){$http.get("/api/v1/accounts/token").success(function(token){SweetAlert.swal({title:"Service API Token",text:"<pre><code>"+token+"</code></pre>",html:!0,type:"success",confirmButtonColor:"#1ab394"})}).error(function(err){})},$scope.resetPassword=function(){$uibModal.open({animation:!0,templateUrl:"views/modals/resetPassword.html",controller:"resetPassword",size:"md"})},$scope.activateRegion=function(region){dataStore.setActiveRegion(region),$scope.activeRegion=region,childRefresh(),$http.put("/api/v1/accounts",{aws_region:region})},$scope.activateAccount=function(account){dataStore.setActiveAWS(account),$scope.activeAws=account,childRefresh(),$http.put("/api/v1/accounts",{aws_account:account})},$scope.startup=function(){$scope.isLogin=!0,refresh()},$scope.isLogin&&refresh()}),angular.module("stacks").config(function(toastrConfig){angular.extend(toastrConfig,{closeButton:!0,extendedTimeOut:1e3,progressBar:!0,tapToDismiss:!0,timeOut:5e3,toastClass:"toast"}),angular.extend(toastrConfig,{containerId:"toast-container",maxOpened:5,newestOnTop:!1,positionClass:"toast-top-right",preventDuplicates:!1,preventOpenDuplicates:!1})}),angular.module("stacks").config(function(laddaProvider){laddaProvider.setOption({style:"expand-left",spinnerSize:20,spinnerColor:"#ffffff"})}),angular.module("stacks").factory("dataStore",function($localStorage,$window){return{setStack:function(stack_name){$localStorage.stack_name=stack_name},getStack:function(){return $localStorage.stack_name},setIsLogin:function(bool){$localStorage.isLogin=bool},getIsLogin:function(){return $localStorage.isLogin},clearStack:function(){$localStorage.stack_name=""},setActiveUser:function(email){$localStorage.email=email},getActiveUser:function(){return $localStorage.email},setActiveAWS:function(account){$localStorage.aws_account=account},getActiveAWS:function(){return $localStorage.aws_account||"DEFAULT"},setActiveRegion:function(region){$localStorage.aws_region=region},getActiveRegion:function(){return $localStorage.aws_region||"us-east-1"},getCmsType:function(){return $localStorage.cms_type},setCmsType:function(cms_type){$localStorage.cms_type=cms_type},getCmsName:function(){return $localStorage.cms_name},setCmsName:function(cms_name){$localStorage.cms_name=cms_name},setToken:function(token){$localStorage.token=token},getToken:function(){return $localStorage.token},setBuildSize:function(build_type){$localStorage.build_type=build_type},getBuildSize:function(){return $localStorage.build_type},setRegion:function(region){$localStorage.region=region},getRegion:function(){return $localStorage.region},clearAll:function(){$localStorage.$reset()}}}),angular.module("stacks").factory("httpRequestInterceptor",function(dataStore){return{request:function(config){return config.headers.aws_account=dataStore.getActiveAWS()||"DEFAULT",config.headers.aws_region=dataStore.getActiveRegion()||"us-east-1",config.headers.token=dataStore.getToken()||"",config}}}),angular.module("stacks").factory("httpResponseInterceptor",function($location,$q){return{responseError:function(err){return 401===err.status?($location.path("/login"),$q.reject(err)):$q.reject(err)}}}),angular.module("stacks").config(function($httpProvider){$httpProvider.interceptors.push("httpResponseInterceptor"),$httpProvider.interceptors.push("httpRequestInterceptor")}),angular.module("stacks").controller("stacksController",function($rootScope,$interval,$scope,$http,$state,$uibModal,SweetAlert,dataStore,toastr){function refresh(){$http.get("/api/v1/stacks").success(function(response){$scope.stacks=response}).error(function(err){toastr.error(err,"AWS Error")})}function refresher(){intervalPromise=$interval(function(){refresh()},15e3)}$scope.$on("refresh",function(){refresh()}),$scope.openCreateForm=function(){var modalInstance=$uibModal.open({animation:!0,templateUrl:"views/modals/createStack.html",controller:"createStack",size:"md"});modalInstance.result.then(function(selectedItem){refresh()})},$scope.openStack=function(stack_name){dataStore.setStack(stack_name),$state.go("index.detail",{stack_name:stack_name})},$scope.deleteStack=function($event,stack_name){$event.stopImmediatePropagation(),SweetAlert.swal({title:"Are you sure?",text:"All stack resources will be removed: "+stack_name,type:"warning",showCancelButton:!0,confirmButtonColor:"#1ab394",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(isConfirm){isConfirm&&$http["delete"]("/api/v1/stacks/"+stack_name).success(function(res){SweetAlert.swal("Success",stack_name+" is being deprovisioned.","success"),refresh()}).error(function(err){toastr.error(err,"AWS Error")})})},$scope.panelColor=function(status){switch(!0){case status.includes("DELETE_IN_PROGRESS"):return"panel panel-danger";case status.includes("ROLLBACK"):return"panel panel-warning";case status.includes("PROGRESS"):return"panel panel-info";case status.includes("FAILED"):return"panel panel-danger";default:return"panel panel-primary"}},$scope.stackStatus=function(status){switch(!0){case status.includes("DELETE_IN_PROGRESS"):return"fa fa-cloud";case status.includes("ROLLBACK"):return"fa fa-cloud";case status.includes("PROGRESS"):return"fa fa-ship";case status.includes("FAILED"):return"fa fa-cloud";default:return"fa fa-sun-o"}},$scope.isUpdating=function(status){return!!status.includes("PROGRESS")};var intervalPromise;$scope.$on("$destroy",function(){$interval.cancel(intervalPromise)}),refresh(),refresher()}),angular.module("stacks").controller("stackController",function($scope,$q,$interval,$stateParams,$http,$uibModal,SweetAlert,dataStore,_,toastr){function mergeEc2Objects(group1,group2){return _.each(group1,function(y){var obj=_.find(group2,function(x){return x.InstanceId===y.InstanceId});return y.PrivateIpAddress=obj.PrivateIpAddress,y.PublicIpAddress=obj.PublicIpAddress,y.KeyName=obj.KeyName,y.InstanceType=obj.InstanceType,y.LaunchTime=obj.LaunchTime,y.ImageId=obj.ImageId,y})}function updateEc2(){_.each($scope.scaleGroups,function(group,index){if(group.Instances.length<1)return group;var instances=_.pluck(group.Instances,"InstanceId");$http.get("/api/v1/ec2/"+instances).success(function(data){$scope.scaleGroups[index].Instances=mergeEc2Objects(group.Instances,data)}).error(function(err){toastr.error(err,"AWS Error")})})}function getEc2(instances){var instance_ids=_.pluck(instances,"PhysicalResourceId");$http.get("/api/v1/ec2/"+instance_ids).success(function(data){$scope.instances=data}).error(function(err){toastr.error(err,"AWS Error")})}function addTags(){_.each($scope.scaleGroups,function(group,index){$scope.scaleGroups[index].version=_.find(group.Tags,function(tag){return"version"===tag.Key}).Value,$scope.scaleGroups[index].app_name=_.find(group.Tags,function(tag){return"app_name"===tag.Key}).Value})}function updateElb(){_.each($scope.scaleGroups,function(group,index){return group.LoadBalancerNames.length<1?group:void $http.get("/api/v1/elb/"+group.LoadBalancerNames).success(function(data){$scope.scaleGroups[index].LoadBalancerNames=data.LoadBalancerDescriptions}).error(function(err){toastr.error(err,"AWS Error")})})}function updateScaleGroups(scaleGroups){var groups=_.pluck(scaleGroups,"PhysicalResourceId");$http.get("/api/v1/asg/describe/"+groups).success(function(response){$scope.scaleGroups=response.AutoScalingGroups,updateEc2(),updateElb(),addTags()}).error(function(err){toastr.error(err,"AWS Error")})}function refresh(){$http.get("/api/v1/stacks/status/"+$scope.stack_name).success(function(response){$scope.stack_status=response}).error(function(err){toastr.error(err,"AWS Error")}),$http.get("/api/v1/stacks/"+$scope.stack_name).success(function(data){$scope.resources=data.StackResources;var instances=_.filter(data.StackResources,function(x){return"AWS::EC2::Instance"===x.ResourceType}),scaleGroups=_.filter(data.StackResources,function(x){return"AWS::AutoScaling::AutoScalingGroup"===x.ResourceType});scaleGroups.length>0?updateScaleGroups(scaleGroups):instances.length>0&&getEc2(instances)}).error(function(err){toastr.error(err,"AWS Error")}),$http.get("/api/v1/stacks/describeEvents/"+$scope.stack_name).success(function(response){$scope.stack_logs=response}).error(function(err){toastr.error(err,"AWS Error")}),$http.get("/api/v1/chef/environments/"+$scope.stack_name).success(function(response){var defaults=response.default_attributes;defaults&&($scope.chef_status=defaults.status,$scope.rollback_available=defaults.rollback_available,$scope.chef=defaults.cloudsu_params)}).error(function(err){toastr.error(err,"Chef Error")})}function refresher(){intervalPromise=$interval(function(){refresh()},15e3)}if($scope.stack_name=$stateParams.stack_name,$scope.stack_name){$scope.adjustSize=function(app_name,version){var modalInstance=$uibModal.open({animation:!0,templateUrl:"views/modals/groupResize.html",controller:"groupResize",size:"md",resolve:{stack_name:function(){return $scope.stack_name},app_name:function(){return app_name},version:function(){return version}}});modalInstance.result.then(function(selectedItem){refresh()})},$scope.detachElb=function(scale_group,elb_name){console.log(scale_group,elb_name),SweetAlert.swal({title:"",text:"Are you sure you want to detach this ELB?",type:"warning",showCancelButton:!0,confirmButtonColor:"#1ab394",confirmButtonText:"Yes",closeOnConfirm:!1},function(isConfirm){isConfirm&&$http.patch("/api/v1/elb/disconnect",{scale_group:scale_group,elb:elb_name}).success(function(response){refresh(),SweetAlert.swal("Success",elb_name+" has been detached from scale group "+scale_group,"success")}).error(function(err){toastr.error(err,"AWS Error")})})},$scope.removeAsg=function(app_name,version){var params={app_name:app_name,version:version,stack_name:$scope.stack_name};$http.patch("/api/v1/delete_asg",params).error(function(err){toastr.error(err,"AWS Error")})},$scope.availableElbs=function(scale_group){$http.get("/api/v1/available_elbs/"+$scope.stack_name).success(function(response){var modalInstance=$uibModal.open({animation:!0,templateUrl:"views/modals/connectElb.html",controller:"connectElb",size:"md",resolve:{elbs:function(){return response},scale_group:function(){return scale_group}}}).error(function(err){toastr.error(err,"AWS Error")});modalInstance.result.then(function(selectedItem){refresh()})})},$scope.openUpgradeForm=function(){$scope.stack_name=dataStore.getStack(),$uibModal.open({animation:!0,templateUrl:"views/modals/upgradeStack.html",controller:"upgradeStack",size:"md",resolve:{stack_name:function(){return $scope.stack_name},build_size:function(){return $scope.chef.build_size}}})},$scope.rollback=function(){$uibModal.open({animation:!0,templateUrl:"views/modals/stackRollback.html",controller:"stackRollback",size:"md",resolve:{stack_name:function(){return $scope.stack_name}}})},$scope.openEnvEditor=function(){$http.get("/api/v1/chef/environments/"+$scope.stack_name).success(function(response){$uibModal.open({animation:!0,templateUrl:"views/modals/editor.html",controller:"chefEditor",size:"lg",resolve:{environment:function(){return response},stack_name:function(){return $scope.stack_name}}})}).error(function(err){toastr.error(err,"Chef Error")})},$scope.openStackEditor=function(){$http.get("/api/v1/stacks/template/"+$scope.stack_name).success(function(response){$scope.template=response,$uibModal.open({animation:!0,templateUrl:"views/modals/editor.html",controller:"templateEditor",size:"lg",resolve:{template:function(){return $scope.template},stack_name:function(){return $scope.stack_name}}})}).error(function(err){toastr.error(err,"AWS Error")})},$scope.saveJSON=function(){$scope.toJSON="",$scope.toJSON=angular.toJson($scope.stack_logs);var blob=new Blob([$scope.toJSON],{type:"application/json;charset=utf-8;"}),downloadLink=angular.element("<a></a>");downloadLink.attr("href",window.URL.createObjectURL(blob)),downloadLink.attr("download",$scope.stack_name+"-CF-LOGS.json"),downloadLink[0].click()},$scope.status_label=function(status){return"READY"!==status?"badge badge-warning":"badge badge-primary"},$scope.status_fa_label=function(status){return"READY"!==status?"fa fa-circle-o-notch fa-spin":"fa fa-check-circle"},$scope.stack_status_label=function(status){return"UPDATE_COMPLETE"===status||"CREATE_COMPLETE"===status?"badge badge-primary":"badge badge-warning"},$scope.stack_status_fa_label=function(status){return status&&status.includes("PROGRESS")?"fa fa-circle-o-notch fa-spin":"fa fa-check-circle"},$scope.isHappy=function(status){return"Healthy"===status?"fa fa-smile-o":"fa fa-frown-o"},$scope.inService=function(status){return"InService"===status?"fa  fa-thumbs-up":"fa fa-circle-o-notch fa-spin"},$scope.logColor=function(status){return status.includes("FAILED")?"danger":void 0},$scope.rowColor=function(health,state){return"Healthy"===health&&"InService"===state?void 0:"Unhealthy"===health?"danger":"warning"};var intervalPromise;$scope.$on("$destroy",function(){$interval.cancel(intervalPromise)}),refresh(),refresher()}}),angular.module("stacks").controller("loginController",function($rootScope,$scope,$http,$state,$uibModal,dataStore,toastr){$scope.showSpinner=!1,dataStore.clearAll(),$scope.attemptLogin=function(){var user={name:$scope.user.name,password:$scope.user.password};$scope.showSpinner=!0,$http.post("/api/v1/accounts/login",user).success(function(user){$scope.showSpinner=!1,dataStore.setToken(user.token),dataStore.setActiveUser(user.name),dataStore.setActiveAWS(user.aws_account),dataStore.setActiveRegion(user.aws_region),dataStore.setIsLogin(!0),$scope.startup(),user.aws_account&&($scope.$parent.activeAws=user.aws_account),user.aws_region&&($scope.$parent.activeRegion=user.aws_region),user.name&&($scope.$parent.userName=user.name),$state.go("index.stacks")}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")})},$scope.setup=function(){$http.get("/api/v1/ping/"+dataStore.getToken()).success(function(res){res.setup?toastr.error("System has already been setup","Error"):$uibModal.open({animation:!0,templateUrl:"views/setup.html",controller:"setup",size:"md",resolve:{items:function(){return $scope.items}}})})},$scope["import"]=function(){$http.get("/api/v1/ping/"+dataStore.getToken()).success(function(res){res.setup?toastr.error("System has already been setup","Error"):$uibModal.open({animation:!0,templateUrl:"views/modals/import.html",controller:"import",size:"md"})})}}),angular.module("stacks").controller("setup",function($scope,$http,$state,$interval,$uibModalInstance,dataStore,toastr,SweetAlert){function refresher(){intervalPromise=$interval(function(){$http.get("/api/v1/ping/"+dataStore.getToken()).success(function(res){if(res.setup)$scope.bar_value=100,setTimeout(function(){$uibModalInstance.close(!0)},2e3);else if($scope.bar_value<89){var randomNum=Math.floor(10*Math.random())+5;$scope.bar_value=$scope.bar_value+randomNum}})},5e3)}$scope.showSpinner=!1,$scope.activeTab="aws-tab",$scope.bar_value=0,$http.get("/api/v1/regions").success(function(regions){$scope.regions=regions}).error(function(err){toastr.error(err,"Error")});var intervalPromise;$scope.create=function(){return $scope.account.aws.type="AWS",$scope.account.aws.name="DEFAULT",$scope.account.cms.type="CMS",$scope.account.cms.name="DEFAULT",$scope.account.cms.server="CHEF",$scope.account.user.type="USER",$scope.account.user.password!==$scope.account.user.confirm?toastr.error("Passwords do not match","Error"):($scope.showSpinner=!0,void $http.post("/api/v1/setup/"+$scope.account.aws.name,$scope.account).success(function(response){$scope.showSpinner=!1,$scope.bar_value=$scope.bar_value+10,refresher()}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")}))},$scope.setActiveTab=function(tab){$scope.activeTab=tab},$scope.isFirst=function(){return"aws-tab"===$scope.activeTab},$scope.isLast=function(){return"user-tab"===$scope.activeTab},$scope.activeNavTab=function(tab){return $scope.activeTab===tab?"active":void 0},$scope.activeContentTab=function(tab){return $scope.activeTab===tab?"tab-pane active":"tab-pane"},$scope.next=function(tab){"aws-tab"===$scope.activeTab?$scope.activeTab="chef-tab":"chef-tab"===$scope.activeTab&&($scope.activeTab="user-tab")},$scope.previous=function(){"chef-tab"===$scope.activeTab?$scope.activeTab="aws-tab":"user-tab"===$scope.activeTab&&($scope.activeTab="chef-tab")},$scope.$on("$destroy",function(){$interval.cancel(intervalPromise)}),$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("stacks").controller("createStack",function($scope,$http,$state,$uibModalInstance,dataStore,_,toastr){$scope.sgs=[],$scope.elb_sgs=[],$scope.stack={},$scope.stack.instance_store=!1,$scope.stack.ebs_volume=!1,$scope.stack.multi_az=!1,$scope.stack.type="create",$scope.stack.ebs_root_size=30,$scope.showSpinner=!1,$scope.stack.volumes=[],$scope.stack.recipes=[],$scope.activeTab="stack-tab",$scope.last_name,$scope.chef_preview={description:"Managed by cloudsu",json_class:"Chef::Environment",chef_type:"environment",default_attributes:{},override_attributes:{}},$http.get("/api/v1/ec2/sample/images").success(function(response){$scope.images=response}),$http.get("/api/v1/ec2/sizes").success(function(res){$scope.instanceSizes=res.reverse()}),$http.get("/api/v1/iam/ssl").success(function(res){$scope.ssls=res}),$http.get("/api/v1/ec2/keys").success(function(res){$scope.keys=res}),$http.get("/api/v1/iam/roles").success(function(res){$scope.roles=res}),$http.get("/api/v1/region_map").success(function(response){$scope.regions=response}),$http.get("/api/v1/ec2/security_groups").success(function(response){$scope.security_groups=response}),$scope.createStack=function(){if($scope.showSpinner=!0,!$scope.stack.stack_name||$scope.stack.stack_name.match(/[^0-9a-z]/i))return toastr.error("AWS only allows Alphanumeric characters for stack names","Error"),void($scope.showSpinner=!1);$scope.stack.recipes_string?$scope.stack.recipes=$scope.stack.recipes_string.replace(/ /g,"").split(","):$scope.stack.recipes=[],"HA"===$scope.stack.build_size?$scope.stack.multi_az?$scope.stack.regions=$scope.regions:$scope.stack.regions=[$scope.stack.region]:$scope.stack.regions=$scope.stack.region,$scope.stack.elb_security_groups=_.pluck($scope.elb_sgs,"GroupId"),$scope.stack.security_groups=_.pluck($scope.sgs,"GroupId"),$scope.stack.create_elb||($scope.stack=_.omit($scope.stack,["elb","elb_security_groups"]));var url=["/api/v1/stacks",$scope.stack.stack_name].join("/");$http.post(url,$scope.stack).success(function(res){$scope.showSpinner=!1,$uibModalInstance.close(!0)}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")})},$scope.envChange=function(){if($scope.last_name){const new_defaults=_.omit($scope.chef_preview.default_attributes,[$scope.last_name]);$scope.chef_preview.default_attributes=new_defaults}$scope.stack.stack_name&&($scope.chef_preview.name=$scope.stack.stack_name),$scope.stack.app_name&&$scope.stack.app_version&&($scope.chef_preview.default_attributes[$scope.stack.app_name]={},$scope.chef_preview.default_attributes[$scope.stack.app_name].version=$scope.stack.app_version),$scope.stack.domain&&($scope.chef_preview.default_attributes.domain=$scope.stack.domain),$scope.last_name=_.clone($scope.stack.app_name)},$scope.setActiveTab=function(tab){$scope.activeTab=tab},$scope.isFirst=function(){return"stack-tab"===$scope.activeTab},$scope.isLast=function(){return"scripts-tab"===$scope.activeTab},$scope.activeNavTab=function(tab){return $scope.activeTab===tab?"active":void 0},$scope.activeContentTab=function(tab){return $scope.activeTab===tab?"tab-pane active":"tab-pane"},$scope.next=function(tab){"stack-tab"===$scope.activeTab?$scope.activeTab="launch-config-tab":"launch-config-tab"===$scope.activeTab?$scope.activeTab="storage-tab":"storage-tab"===$scope.activeTab?"HA"===$scope.stack.build_size&&$scope.stack.create_elb?$scope.activeTab="elb-tab":$scope.activeTab="scripts-tab":"elb-tab"===$scope.activeTab&&($scope.activeTab="scripts-tab")},$scope.previous=function(){"launch-config-tab"===$scope.activeTab?$scope.activeTab="stack-tab":"storage-tab"===$scope.activeTab?$scope.activeTab="launch-config-tab":"elb-tab"===$scope.activeTab?$scope.activeTab="storage-tab":"scripts-tab"===$scope.activeTab&&("HA"===$scope.stack.build_size&&$scope.stack.create_elb?$scope.activeTab="elb-tab":$scope.activeTab="storage-tab")},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.addVolume=function(){$scope.stack.volumes.push({type:"gp2",size:30})},$scope.removeVolume=function(index){$scope.stack.volumes.splice(index,1)},$scope.addSecurityGroup=function(group){$scope.sgs.push(group)},$scope.removeSecurityGroup=function(index){$scope.sgs.splice(index,1)},$scope.addElbSecurityGroup=function(group){$scope.elb_sgs.push(group)},$scope.removeElbSecurityGroup=function(index){$scope.elb_sgs.splice(index,1)}}),angular.module("stacks").controller("usersController",function($scope,$http,$state,$uibModal,SweetAlert,dataStore,toastr){function refresh(){$http.get("api/v1/accounts/").success(function(users){$scope.users=users,$scope.admin=!0}).error(function(err){$scope.admin=!1})}$scope.admin=!0,$scope.createUser=function(){var modalInstance=$uibModal.open({animation:!0,templateUrl:"views/modals/createUser.html",controller:"createUser",size:"md",resolve:{}});modalInstance.result.then(function(){refresh()})},$scope.editUser=function(user){SweetAlert.swal({title:"",text:"Switch "+user.name+" admin status?",type:"warning",showCancelButton:!0,confirmButtonColor:"#1ab394",confirmButtonText:"Yes",closeOnConfirm:!1},function(isConfirm){isConfirm&&(user.admin=!user.admin,$http.put("/api/v1/accounts/",user).success(function(response){refresh(),SweetAlert.swal("Success",user.name+" admin status has been changed to: "+user.admin,"success")}).error(function(err){toastr.error(err,"Error")}))})},$scope.removeUser=function(user){SweetAlert.swal({title:"Are you sure?",text:"User will be removed from the database: "+user.name,type:"warning",showCancelButton:!0,confirmButtonColor:"#1ab394",confirmButtonText:"Yes, delete user!",closeOnConfirm:!1},function(isConfirm){isConfirm&&$http["delete"]("/api/v1/accounts/"+user.name).success(function(res){SweetAlert.swal("Success",user.name+" has been removed.","success"),refresh()}).error(function(err){toastr.error(err,"AWS Error")})})},refresh()}),angular.module("stacks").controller("createUser",function($scope,$http,$state,$uibModalInstance,dataStore,_,toastr){$scope.token=!1,$scope.user={},$scope.user.type="USER",$scope.user.email_pass=!1,$scope.showSpinner=!1,$scope.create=function(){if($scope.user.password!==$scope.user.confirm&&"User"===$scope.user.user_type&&!$scope.user.email_pass)return toastr.error("Passwords do not match","Error");if("Service"===$scope.user.user_type||$scope.user.email_pass&&"User"===$scope.user.user_type);else if($scope.user.password.length<8&&"User"===$scope.user.user_type&&!$scope.user.email_pass)return toastr.error("Passwords must be at least 8 characters","Error");$scope.showSpinner=!0,$http.post("/api/v1/accounts",$scope.user).success(function(response){$scope.showSpinner=!1,response.service_token?$scope.token=response.service_token:$uibModalInstance.close("success")}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")})},$scope.cancel=function(){$uibModalInstance.close("success")}}),angular.module("stacks").controller("resetPassword",function($scope,$http,$state,$uibModalInstance,toastr){$scope.showSpinner=!1,$scope.save=function(){return $scope.user.password!==$scope.user.confirm?toastr.error("Passwords do not match","Error"):$scope.user.password<8?toastr.error("Passwords must be at least 8 characters","Error"):($scope.showSpinner=!0,void $http.put("/api/v1/accounts/reset",$scope.user).success(function(response){$scope.showSpinner=!1,$uibModalInstance.dismiss("cancel")}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")}))},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("stacks").controller("system",function($scope,$http,$uibModal,dataStore,SweetAlert,toastr){function refresh(){$http.get("/api/v1/services/get_accounts/AWS").success(function(response){$scope.admin=!0,$scope.aws_accounts=response}).error(function(err){$scope.admin=!1})}$scope.admin=!0,$scope.chefModal=function(){$http.get("/api/v1/services/get_account/CMS/DEFAULT").success(function(response){$uibModal.open({animation:!0,templateUrl:"views/modals/chef.html",size:"md",controller:"serviceAccount",resolve:{account:function(){return response},type:function(){return"CMS"}}})}).error(function(err){toastr.error(err,"Error")})},$scope.awsModal=function(account){var modalInstance=$uibModal.open({animation:!0,templateUrl:"views/modals/aws.html",size:"md",controller:"serviceAccount",resolve:{account:function(){return account},type:function(){return"AWS"}}});modalInstance.result.then(function(selectedItem){refresh(),$scope.startup()})},$scope.removeAccount=function(account){SweetAlert.swal({title:"Are you sure?",text:"Account will be removed: "+account.name,type:"warning",showCancelButton:!0,confirmButtonColor:"#1ab394",confirmButtonText:"Yes",closeOnConfirm:!1},function(isConfirm){isConfirm&&$http["delete"](["/api/v1/services",account.type,account.name].join("/")).success(function(response){SweetAlert.swal("Success",account.name+" has been removed.","success"),refresh(),$scope.activateAccount("DEFAULT"),$scope.startup()}).error(function(err){toastr.error(err,"Error")})})},$scope.exportConfig=function(){$scope.toJSON="",$scope.showSpinner=!0,$http.get("/api/v1/system/export").success(function(config){$scope.toJSON=angular.toJson(config);var blob=new Blob([$scope.toJSON],{type:"application/json;charset=utf-8;"}),downloadLink=angular.element("<a></a>");downloadLink.attr("href",window.URL.createObjectURL(blob)),downloadLink.attr("download","secrets.json"),downloadLink[0].click()}).error(function(err){toastr.error(err,"Error")})},refresh()}),angular.module("stacks").controller("serviceAccount",function($scope,$http,$uibModalInstance,dataStore,_,account,type,toastr){$scope.account=account||{},$scope.account.type=type,$scope.showSpinner=!1,$scope.saveServiceAccount=function(){$scope.showSpinner=!0,$http.post("/api/v1/services/save_account",$scope.account).success(function(res){$scope.showSpinner=!1,$uibModalInstance.close(!0)}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("stacks").controller("upgradeStack",function($scope,$http,$uibModalInstance,dataStore,toastr,stack_name,build_size){
$scope.advanced=!1,$scope.stack={},$scope.stack.type="upgrade",$scope.stack.stack_name=stack_name,$scope.showSpinner=!1,$scope.upgrade_options=!0,$scope.build_size=build_size,$http.get("/api/v1/ec2/sizes").success(function(response){$scope.instanceSizes=response}),$http.get("/api/v1/chef/environments/"+stack_name).success(function(response){var defaults=response.default_attributes;if(defaults){var chef=defaults.cloudsu_params;$scope.stack.min_size=chef.min_size,$scope.stack.desired_size=chef.desired_size,$scope.stack.max_size=chef.max_size,$scope.current_version=chef.app_version,$scope.stack.ami=chef.ami,$scope.stack.instance_size=chef.instance_size,$scope.stack.app_name=chef.app_name}}),$scope.upgrade=function(){$scope.showSpinner=!0,$http.patch("/api/v1/upgrade",$scope.stack).success(function(data){$scope.showSpinner=!1,$uibModalInstance.close(!0)}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("stacks").controller("templateEditor",function($scope,$http,$uibModalInstance,template,stack_name,dataStore,toastr){$scope.name=stack_name,$scope.showSpinner=!1,$scope.myInitCallback=function(editor){var o=JSON.parse(template);$scope.editorData=JSON.stringify(o,null,4),editor.$blockScrolling=1/0,editor.session.setMode("ace/mode/json"),editor.setOption("showPrintMargin",!1),editor.getSession().setTabSize(4)},$scope.onDeploy=function(){$scope.showSpinner=!0,$http.put("/api/v1/stacks/"+stack_name,{template:$scope.editorData,stack_name:stack_name}).success(function(data){$scope.showSpinner=!1,$uibModalInstance.close()}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("stacks").controller("stackRollback",function($scope,$http,$uibModalInstance,stack_name,dataStore,toastr){$scope.stack_name=stack_name,$scope.showSpinner=!1,$http.get("/api/v1/chef/rollback_check/"+$scope.stack_name).success(function(response){$scope.rollback_available=response}).error(function(err){toastr.error(err,"Error")}),$scope.rollback=function(){$scope.showSpinner=!0,$http.patch("/api/v1/upgrade/rollback",{stack_name:$scope.stack_name}).success(function(response){$scope.showSpinner=!1,$uibModalInstance.dismiss("cancel")}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("stacks").controller("groupResize",function($scope,$http,$uibModalInstance,stack_name,app_name,version,dataStore,toastr){$scope.showSpinner=!1;var params={stack_name:stack_name,app_name:app_name,version:version};$scope.adjustSize=function(){$scope.showSpinner=!0,params=_.extend(params,$scope.adjust),$http.patch("/api/v1/adjust_size",params).success(function(response){$scope.showSpinner=!1,$uibModalInstance.close(!0)}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Error")})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("stacks").controller("connectElb",function($scope,$http,$uibModalInstance,elbs,scale_group,dataStore,toastr){$scope.elbs=elbs,$scope.showSpinner=!1,$scope.connect=function(){$scope.showSpinner=!0,$http.patch("/api/v1/elb/connect",{scale_group:scale_group,elb:$scope.elb_name}).success(function(data){$scope.showSpinner=!1,$uibModalInstance.close(!0)}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"AWS Error")})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("stacks").controller("chefEditor",function($scope,$http,$uibModalInstance,environment,dataStore,toastr){$scope.showSpinner=!1,$scope.name=environment.name,$scope.myInitCallback=function(editor){var string=JSON.stringify(environment,null,4);$scope.editorData=string,editor.$blockScrolling=1/0,editor.session.setMode("ace/mode/json"),editor.getSession().setTabSize(4),editor.setOption("showPrintMargin",!1)},$scope.onDeploy=function(){$scope.showSpinner=!0,$http.put("/api/v1/chef/environments/update",$scope.editorData).success(function(data){$scope.showSpinner=!1,$uibModalInstance.dismiss()}).error(function(err){$scope.showSpinner=!1,toastr.error(err,"Chef Error")})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}),angular.module("stacks").controller("import",function($scope,$http,$uibModalInstance,toastr){$scope.showSpinner=!1,$scope.importConfig=function(){return $scope.showSpinner=!0,$scope.config?void $http.post("/api/v1/system/import",$scope.config).success(function(response){$scope.showSpinner=!0,$uibModalInstance.close(!0)}).error(function(err){$scope.showSpinner=!0,toastr.error(err,"Error")}):void($scope.showSpinner=!0)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}});